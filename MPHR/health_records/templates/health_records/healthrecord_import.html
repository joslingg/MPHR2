{% extends 'health_records/base.html' %}
{% block title %}Import h·ªì s∆° s·ª©c kh·ªèe{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">üì§ Import h·ªì s∆° s·ª©c kh·ªèe</h3>
    <a href="{% url 'healthrecord_list' %}" class="btn btn-secondary">‚¨Ö Quay l·∫°i</a>
  </div>

  <div class="card shadow-sm p-4">
    <form id="importForm" method="post" enctype="multipart/form-data" action="#">
      {% csrf_token %}
      <div class="mb-3">
        <label class="form-label fw-semibold">Ch·ªçn file Excel (.xlsx):</label>
        <input type="file" name="file" id="fileInput" accept=".xlsx" class="form-control" required>
      </div>

      <div class="d-flex justify-content-end gap-2">
        <a href="{% url 'download_sample_healthrecord' %}" class="btn btn-outline-info">
          üìÑ T·∫£i file m·∫´u
        </a>
        <button type="submit" class="btn btn-primary">
          üì• Import & Xem tr∆∞·ªõc
        </button>
      </div>
    </form>
  </div>

  <!-- K·∫øt qu·∫£ preview s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
  <div id="preview-area" class="mt-4"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('importForm').addEventListener('submit', function (e) {
  e.preventDefault();
  const formData = new FormData(this);
  const fileInput = document.getElementById('fileInput');
  if (!fileInput.files.length) {
    alert('Vui l√≤ng ch·ªçn file Excel.');
    return;
  }

  fetch("{% url 'healthrecord_import_preview_ajax' %}", {
    method: "POST",
    body: formData,
    headers: { "X-CSRFToken": getCookie("csrftoken") },
  })
  .then(res => res.json())
  .then(data => {
    if (data.error) {
      alert("L·ªói: " + data.error);
    } else {
      document.getElementById("preview-area").innerHTML = data.html;
    }
  })
  .catch(err => {
    console.error(err);
    alert("L·ªói h·ªá th·ªëng khi ƒë·ªçc file.");
  });
});

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === name + "=") {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
// CSRF helper
function getCookie(name){
  let v=null;
  if(document.cookie){
    document.cookie.split(';').forEach(c=>{
      const [k,val]=c.trim().split('=');
      if(k===name) v=decodeURIComponent(val);
    });
  }
  return v;
}

// SAVE
function submitHealthImport(batch_id){
  if(!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën l∆∞u t·∫•t c·∫£ d·ªØ li·ªáu h·ª£p l·ªá?")) return;

  fetch(`/records/import/submit/${batch_id}/`, {
    method: 'POST',
    headers: { 'X-CSRFToken': getCookie('csrftoken') },
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.success){
      alert("ƒê√£ l∆∞u th√†nh c√¥ng!");
      document.getElementById("preview-area").innerHTML = "";
    } else {
      alert("L·ªói l∆∞u: " + (d.error || ""));
    }
  });
}

// CANCEL ‚Äî Ch√≠nh x√°c 100% ch·∫°y
document.addEventListener('click', function(e){
  const btn = e.target.closest('[data-action="cancel-import"]');
  if(!btn) return;

  const batch = btn.dataset.batch;
  if(!confirm("B·∫°n c√≥ mu·ªën hu·ª∑ batch import n√†y?")) return;

  fetch(`/records/import/cancel/${batch}/`, {
    method: 'POST',
    headers: { 'X-CSRFToken': getCookie('csrftoken') }
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.success){
      alert("ƒê√£ hu·ª∑ batch import.");
      document.getElementById("preview-area").innerHTML = "";
    } else {
      alert("Hu·ª∑ th·∫•t b·∫°i: " + (d.error || ""));
    }
  })
  .catch(err => alert("L·ªói h·ªá th·ªëng khi hu·ª∑."));
});
</script>
{% endblock %}

