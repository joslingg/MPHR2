{% extends 'health_records/base.html' %}
{% block title %}Trang ch·ªß - H·ªì s∆° kh√°m s·ª©c kho·∫ª{% endblock %}
{% block content %}

<div class="container mt-4">
  <h3 class="text-center mb-4">
    üè• H·ªá th·ªëng qu·∫£n l√Ω h·ªì s∆° kh√°m s·ª©c kho·∫ª
  </h3>

  <!-- Th·∫ª th·ªëng k√™ t·ªïng quan -->
  <div class="row text-center mb-5">
    <div class="col-md-4 mb-3">
      <div class="card shadow-sm border-0 bg-primary text-white">
        <div class="card-body">
          <h5 class="card-title">T·ªïng s·ªë h·ªì s∆°</h5>
          <h2 class="fw-bold">{{ total_records }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card shadow-sm border-0 bg-success text-white">
        <div class="card-body">
          <h5 class="card-title">T·ªïng s·ªë khoa/ph√≤ng</h5>
          <h2 class="fw-bold">{{ total_departments }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card shadow-sm border-0 bg-warning text-dark">
        <div class="card-body">
          <h5 class="card-title">S·ªë lo·∫°i kh√°m</h5>
          <h2 class="fw-bold">{{ total_examtypes }}</h2>
        </div>
      </div>
    </div>
  </div>

  <!-- BI·ªÇU ƒê·ªí TR√íN -->
  <div class="row text-center">
    <!-- Bi·ªÉu ƒë·ªì 1: Ph√¢n lo·∫°i s·ª©c kho·∫ª -->
    <div class="col-md-4 mb-4">
      <div class="card p-3 shadow-sm">
        <h5 class="mb-3 fw-semibold">Theo ph√¢n lo·∫°i s·ª©c kho·∫ª</h5>
        <div class="chart-wrapper" style="height: 300px;">
          <canvas id="healthChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Bi·ªÉu ƒë·ªì 2: Theo k·∫øt lu·∫≠n -->
    <div class="col-md-4 mb-4">
      <div class="card p-3 shadow-sm">
        <h5 class="mb-3 fw-semibold">Theo k·∫øt lu·∫≠n</h5>
        <div class="chart-wrapper" style="height: 300px;">
          <canvas id="conclusionChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Bi·ªÉu ƒë·ªì 3: Theo gi·ªõi t√≠nh -->
    <div class="col-md-4 mb-4">
      <div class="card p-3 shadow-sm">
        <h5 class="mb-3 fw-semibold">Theo gi·ªõi t√≠nh</h5>
        <div class="chart-wrapper" style="height: 300px;">
          <canvas id="genderChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- N√∫t ƒëi·ªÅu h∆∞·ªõng -->
  <div class="text-center mt-4">
    <a href="{% url 'healthrecord_list' %}" class="btn btn-outline-primary btn-lg m-2">
      üìÑ H·ªì s∆° s·ª©c kho·∫ª
    </a>
    <a href="{% url 'department_list' %}" class="btn btn-outline-success btn-lg m-2">
      ‚öôÔ∏è Qu·∫£n l√Ω danh m·ª•c
    </a>
    <a href="{% url 'health_report' %}" class="btn btn-outline-info btn-lg m-2">
      üìä B√°o c√°o th·ªëng k√™
    </a>
  </div>
</div>

<!-- Bi·ªÉu ƒë·ªì JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  window.addEventListener("load", function() {
    const chartColors = [
      "#4e79a7","#f28e2b","#e15759","#76b7b2","#59a14f",
      "#edc948","#b07aa1","#ff9da7","#9c755f","#bab0ac"
    ];

    const chartOptions = {
      responsive: true,
      cutout: "65%",
      plugins: {
        legend: {
          position: "bottom",
          labels: { font: { size: 15, weight: "500" }, padding: 15, color: "#333" }
        },
        tooltip: { bodyFont: { size: 14 }, titleFont: { size: 15 } }
      }
    };

    const totalCenterPlugin = {
      id: "totalCenter",
      afterDraw(chart) {
        const { ctx, chartArea: { top, bottom, left, right } } = chart;
        const x = (left + right) / 2;
        const y = (top + bottom) / 2;
        const total = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
        ctx.save();
        ctx.font = "bold 16px sans-serif";
        ctx.fillStyle = "#333";
        ctx.textAlign = "center";
        ctx.fillText(`T·ªïng: ${total}`, x, y + 5);
        ctx.restore();
      }
    };

    // Bi·ªÉu ƒë·ªì 1: Ph√¢n lo·∫°i s·ª©c kh·ªèe
    new Chart(document.getElementById("healthChart"), {
      type: "doughnut",
      data: {
        labels: {{ dept_labels|safe }},
        datasets: [{ data: {{ dept_counts|safe }}, backgroundColor: chartColors }]
      },
      options: chartOptions,
      plugins: [totalCenterPlugin]
    });

    // Bi·ªÉu ƒë·ªì 2: K·∫øt lu·∫≠n
    new Chart(document.getElementById("conclusionChart"), {
      type: "doughnut",
      data: {
        labels: {{ conclusion_labels|safe }},
        datasets: [{ data: {{ conclusion_counts|safe }}, backgroundColor: chartColors }]
      },
      options: chartOptions,
      plugins: [totalCenterPlugin]
    });

    // Bi·ªÉu ƒë·ªì 3: Gi·ªõi t√≠nh
    new Chart(document.getElementById("genderChart"), {
      type: "doughnut",
      data: {
        labels: {{ gender_labels|safe }},
        datasets: [{ data: {{ gender_counts|safe }}, backgroundColor: chartColors }]
      },
      options: chartOptions,
      plugins: [totalCenterPlugin]
    });
  });
</script>


{% endblock %}
