{% extends 'health_records/base.html' %}
{% block title %}{{ title }}{% endblock %}
{% block content %}
<div class="container mt-4">
  <h3 class="mb-3">{{ title }}</h3>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <form method="post" enctype="multipart/form-data" class="card p-4 shadow-sm" novalidate>
    {% csrf_token %}
    <div class="row g-3">
      {# Render t·ª´ng field v·ªõi wrapper form-group ƒë·ªÉ script d·ªÖ thao t√°c #}
      {% for field in form %}
        {# N·∫øu l√† field vaccine_name ho·∫∑c vaccination_date -> g·∫Øn data-vaccine-field="true" #}
        {% if field.name == 'vaccine_name' or field.name == 'vaccination_date' %}
          <div class="col-md-6 form-group" data-vaccine-field="true">
        {% else %}
          <div class="col-md-6 form-group">
        {% endif %}
            <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
            {{ field }}
            {% if field.help_text %}
              <div class="form-text text-muted">{{ field.help_text }}</div>
            {% endif %}
            {% for err in field.errors %}
              <div class="text-danger small mt-1">{{ err }}</div>
            {% endfor %}
          </div>
      {% endfor %}
    </div>

    <div class="mt-4 d-flex justify-content-between">
      <a href="{% url 'healthrecord_list' %}" class="btn btn-secondary">‚¨Ö Quay l·∫°i</a>
      <button type="submit" class="btn btn-primary">üíæ L∆∞u</button>
    </div>
  </form>
</div>

{# Script: toggle vaccine fields + small UX niceties #}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // ID m·∫∑c ƒë·ªãnh c·ªßa Django form field: id_vaccinated, id_vaccine_name, id_vaccination_date
  const vaccinatedCheckbox = document.querySelector('#id_vaccinated');
  const vaccineFields = document.querySelectorAll('[data-vaccine-field="true"]');

  function setVaccineVisibility() {
    const visible = vaccinatedCheckbox && vaccinatedCheckbox.checked;
    vaccineFields.forEach(wrapper => {
      if (visible) {
        wrapper.style.display = '';
        // enable inputs inside
        wrapper.querySelectorAll('input, select, textarea').forEach(i => i.removeAttribute('disabled'));
      } else {
        wrapper.style.display = 'none';
        // disable inputs inside so they aren't submitted accidentally
        wrapper.querySelectorAll('input, select, textarea').forEach(i => i.setAttribute('disabled', 'disabled'));
      }
    });
  }

  if (vaccinatedCheckbox) {
    // kh·ªüi t·∫°o tr·∫°ng th√°i ban ƒë·∫ßu
    setVaccineVisibility();
    // l·∫Øng nghe thay ƒë·ªïi
    vaccinatedCheckbox.addEventListener('change', setVaccineVisibility);
  } else {
    // n·∫øu form kh√¥ng c√≥ tr∆∞·ªùng vaccinated, v·∫´n ·∫©n vaccine fields ƒë·ªÉ an to√†n
    vaccineFields.forEach(wrapper => wrapper.style.display = 'none');
  }

  // Tweak: th√™m class bootstrap cho c√°c input n·∫øu template kh√¥ng t·ª± th√™m
  document.querySelectorAll('input, select, textarea').forEach(el => {
    if (!el.classList.contains('form-control') && !el.classList.contains('form-select') && el.type !== 'checkbox' && el.type !== 'file') {
      el.classList.add('form-control');
    }
    if (el.type === 'checkbox') {
      // b·ªçc checkbox v√†o form-check n·∫øu c·∫ßn
      const parent = el.closest('.form-group');
      if (parent && !parent.querySelector('.form-check')) {
        const wrapper = document.createElement('div');
        wrapper.className = 'form-check';
        el.parentNode.insertBefore(wrapper, el);
        wrapper.appendChild(el);
        // di chuy·ªÉn label
        const lbl = parent.querySelector('label[for="' + el.id + '"]');
        if (lbl) wrapper.appendChild(lbl);
      }
    }
  });
});
</script>
{% endblock %}
