{% extends 'health_records/base.html' %}
{% block title %}Import danh s√°ch nh√¢n vi√™n{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">üì§ Import danh s√°ch nh√¢n vi√™n</h3>
    <a href="{% url 'employee_list' %}" class="btn btn-secondary">‚¨Ö Quay l·∫°i</a>
  </div>

  <div class="card shadow-sm p-4">
    <form id="importForm" method="post" enctype="multipart/form-data" action="#">
      {% csrf_token %}
      <div class="mb-3">
        <label class="form-label fw-semibold">Ch·ªçn file Excel (.xlsx):</label>
        <input type="file" name="file" id="fileInput" accept=".xlsx" class="form-control" required>
      </div>

      <div class="d-flex justify-content-end gap-2">
        <a href="{% url 'download_sample_employee' %}" class="btn btn-outline-info">
          üìÑ T·∫£i file m·∫´u
        </a>
        <button type="submit" class="btn btn-primary">
          üì• Import & Xem tr∆∞·ªõc
        </button>
      </div>
    </form>
  </div>

  <!-- üîπ K·∫øt qu·∫£ preview hi·ªÉn th·ªã t·∫°i ƒë√¢y -->
  <div id="preview-area" class="mt-4"></div>
</div>
{% endblock %}

{% block extra_js %}
<style>
/* ===== Scrollable Preview Table ===== */
.preview-table-container {
  max-height: 60vh;
  overflow-y: auto;
  border: 1px solid #dee2e6;
  border-radius: 8px;
}
.preview-table-container thead th {
  background-color: #247efc !important;
  color: #fff !important;
  position: sticky;
  top: 0;
  z-index: 3;
  border-bottom: 2px solid #c8daf7;
}
.preview-table-container tbody tr.valid-row {
  background-color: #eaf8f0;
}
.preview-table-container tbody tr.invalid-row {
  background-color: #fbeaea;
}
.preview-table-container tbody tr:hover {
  background-color: #f6faff;
}

/* ===== Toast Style ===== */
.custom-toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #333;
  color: white;
  padding: 10px 16px;
  border-radius: 6px;
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.4s ease;
  z-index: 9999;
  font-size: 14px;
}
.custom-toast.show {
  opacity: 1;
  transform: translateY(0);
}
.custom-toast.success { background: #198754; }
.custom-toast.error { background: #dc3545; }
.custom-toast.info { background: #0d6efd; }
</style>

<script>
// ============================
// üß© Import Preview (AJAX)
// ============================
document.getElementById('importForm').addEventListener('submit', function (e) {
  e.preventDefault();
  console.log("üîç B·∫Øt ƒë∆∞·ª£c s·ª± ki·ªán submit, ƒëang g·ª≠i AJAX...");

  const formData = new FormData(this);
  const fileInput = document.getElementById('fileInput');
  if (!fileInput.files.length) {
    showToast("‚ö†Ô∏è Vui l√≤ng ch·ªçn file Excel!", "error");
    return;
  }

  fetch("{% url 'employee_import_preview_ajax' %}", {
    method: "POST",
    body: formData,
    headers: { "X-CSRFToken": getCookie("csrftoken") },
  })
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        showToast("‚ùå " + data.error, "error");
      } else {
        document.getElementById("preview-area").innerHTML = data.html;
        showToast("‚úÖ ƒê√£ t·∫£i d·ªØ li·ªáu xem tr∆∞·ªõc!", "success");
      }
    })
    .catch(err => {
      console.error(err);
      showToast("‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu xem tr∆∞·ªõc.", "error");
    });
});

// ============================
// üíæ Submit Import
// ============================
function submitImport(batch_id) {
  if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën l∆∞u to√†n b·ªô nh√¢n vi√™n h·ª£p l·ªá v√†o h·ªá th·ªëng?")) return;

  fetch(`/employees/import/submit/${batch_id}/`, {
    method: "POST",
    headers: { "X-CSRFToken": getCookie("csrftoken") },
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        showToast("üíæ ƒê√£ l∆∞u th√†nh c√¥ng!", "success");
        document.getElementById("preview-area").innerHTML = "";
        document.getElementById("importForm").reset();
      } else {
        showToast("‚ö†Ô∏è C√≥ l·ªói khi l∆∞u d·ªØ li·ªáu.", "error");
      }
    })
    .catch(() => showToast("‚ùå L·ªói h·ªá th·ªëng khi l∆∞u.", "error"));
}

// ============================
// ‚ùå Cancel Import
// ============================
function cancelImport(batch_id) {
  if (!confirm("Hu·ª∑ batch import n√†y? D·ªØ li·ªáu t·∫°m s·∫Ω b·ªã xo√°.")) return;

  fetch(`/employees/import/cancel/${batch_id}/`, {
    method: "POST",
    headers: { "X-CSRFToken": getCookie("csrftoken") },
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        showToast("üóëÔ∏è ƒê√£ hu·ª∑ batch import.", "info");
        document.getElementById("preview-area").innerHTML = "";
        document.getElementById("importForm").reset();
      }
    })
    .catch(() => showToast("‚ùå L·ªói khi hu·ª∑ import.", "error"));
}

// ============================
// ‚öôÔ∏è Helpers
// ============================
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === name + "=") {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function showToast(message, type = "info") {
  const toast = document.createElement("div");
  toast.className = `custom-toast ${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.classList.add("show"), 50);
  setTimeout(() => {
    toast.classList.remove("show");
    setTimeout(() => toast.remove(), 400);
  }, 3500);
}
</script>
{% endblock %}
