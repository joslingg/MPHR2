{% extends 'health_records/base.html' %}
{% block content %}
<div class="container mt-4">
  <h3 class="text-center mb-4">üìä B√°o c√°o th·ªëng k√™ h·ªì s∆° kh√°m s·ª©c kh·ªèe</h3>

  <div class="row text-center">
    <!-- Bi·ªÉu ƒë·ªì 1: Ph√¢n lo·∫°i s·ª©c kh·ªèe -->
    <div class="col-md-4 mb-4">
      <div class="card p-3 shadow-sm">
        <h5 class="mb-3">Theo ph√¢n lo·∫°i s·ª©c kh·ªèe</h5>
        <div style="height: 350px;">
          <canvas id="healthPieChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Bi·ªÉu ƒë·ªì 2: Theo k·∫øt lu·∫≠n -->
    <div class="col-md-4 mb-4">
      <div class="card p-3 shadow-sm">
        <h5 class="mb-3">Theo k·∫øt lu·∫≠n</h5>
        <div style="height: 350px;">
          <canvas id="conclusionPieChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Bi·ªÉu ƒë·ªì 3: Theo gi·ªõi t√≠nh -->
    <div class="col-md-4 mb-4">
      <div class="card p-3 shadow-sm">
        <h5 class="mb-3">Theo gi·ªõi t√≠nh</h5>
        <div style="height: 350px;">
          <canvas id="genderPieChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const chartColors = [
    "#4e79a7","#f28e2b","#e15759","#76b7b2","#59a14f",
    "#edc948","#b07aa1","#ff9da7","#9c755f","#bab0ac"
  ];

  // üü¢ T√πy ch·ªçn chung cho bi·ªÉu ƒë·ªì
  const chartOptions = {
    responsive: true,
    cutout: "65%",
    plugins: {
      legend: {
        position: "bottom",
        labels: {
          font: { size: 16, weight: "500" },
          padding: 20,
          color: "#333",
        }
      },
      tooltip: {
        bodyFont: { size: 14 },
        titleFont: { size: 16 }
      }
    }
  };

  // üß© Plugin hi·ªÉn th·ªã t·ªïng ·ªü gi·ªØa
  const totalCenterPlugin = {
    id: "totalCenter",
    afterDraw(chart) {
      const { ctx, chartArea: { top, bottom, left, right } } = chart;
      const xCenter = (left + right) / 2;
      const yCenter = (top + bottom) / 2;
      const total = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);

      ctx.save();
      ctx.font = "bold 18px sans-serif";
      ctx.fillStyle = "#333";
      ctx.textAlign = "center";
      ctx.fillText(`T·ªïng: ${total}`, xCenter, yCenter + 5);
      ctx.restore();
    }
  };

  // üü† Bi·ªÉu ƒë·ªì theo ph√¢n lo·∫°i s·ª©c kh·ªèe
  new Chart(document.getElementById("healthPieChart"), {
    type: "doughnut",
    data: {
      labels: {{ dept_labels|safe }},
      datasets: [{
        data: {{ dept_counts|safe }},
        backgroundColor: chartColors
      }]
    },
    options: chartOptions,
    plugins: [totalCenterPlugin]
  });

  // üü£ Bi·ªÉu ƒë·ªì theo k·∫øt lu·∫≠n
  new Chart(document.getElementById("conclusionPieChart"), {
    type: "doughnut",
    data: {
      labels: {{ conclusion_labels|safe }},
      datasets: [{
        data: {{ conclusion_counts|safe }},
        backgroundColor: chartColors
      }]
    },
    options: chartOptions,
    plugins: [totalCenterPlugin]
  });

  // üîµ Bi·ªÉu ƒë·ªì theo gi·ªõi t√≠nh
  new Chart(document.getElementById("genderPieChart"), {
    type: "doughnut",
    data: {
      labels: {{ gender_labels|safe }},
      datasets: [{
        data: {{ gender_counts|safe }},
        backgroundColor: chartColors
      }]
    },
    options: chartOptions,
    plugins: [totalCenterPlugin]
  });
</script>
{% endblock %}
